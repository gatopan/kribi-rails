<% unless target_day %>
  <div class='row'>
    <div class='col-md-2 col-md-offset-5'>
      <h2>Please select an initial day</h2>
      <form
        action="<%= self.send("batch_show_#{children_model.table_name}_batch_index_path") %>"
        method="GET"
      >
        <br />
        <div
          class="input-group input-group-sm date"
            <% datetime_picker_id = SecureRandom.hex %>
            id="datetime-picker-<%= datetime_picker_id %>"
        >
          <input
            name="target_day"
            type='text'
            class="form-control"
            style='min-width: 140px;text-align: center;font-size: 20px;'
            value='<%= target_day ? children_model.target_day.utc.strftime("%d/%m/%Y") : '' %>'
          />
          <span class="input-group-addon">
            <span class="glyphicon glyphicon-calendar"></span>
          </span>
          <span><button>Change</button></span>
          <script type="text/javascript">
            $(function () {
                $('<%= "#datetime-picker-#{datetime_picker_id}" %>').datetimepicker({
                  format: 'DD/MM/YYYY',
                  minDate: false,
                  maxDate: new Date('<%= DateTime.now.utc.strftime("%Y-%m-%d") %>T00:00:00Z'),
                });
                <%# TODO: implement above max date check in backend %>
            });
          </script>
        </div>
      </form>
    </div>
  </div>
<% else %>
  <h2 class='text-center'><%= children.last.target_datetime.utc.strftime("%d/%m/%Y") %></h2>
  <p><a class='date-changer-toggler' href='#'>Change</a></p>

  <% if children_model.is_resettable? %>
    <h4>Show reset/offset options: <input type="checkbox" name="showResetOptions" id="toggle-reset"></h4>
  <% end %>

  <table>
    <thead>
      <tr>
        <th></th>
        <% parents.each do |parent| %>
          <th colspan="<%= children_attributes.count %>"><%= "#{parent_model.to_s.humanize} #{parent.id}" %></th>
        <% end %>
      </tr>
      <tr>
        <th>Time</th>
        <% parents.each do |parent| %>
          <% children_attributes.each do |options| %>
            <th><%= label_tag(options[:attribute], options[:custom_name], class: (options[:class] =~ /reset-toggleable/ ? 'reset-toggleable' : '')) %></th>
          <% end %>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% combined_target_datetimes.each do |target_datetime| %>
        <% target_datetime_children = combined_children.where(target_datetime: target_datetime) %>
        <tr>
          <td><%= target_datetime.strftime("%H:%M") %></td>
          <% parents.each do |parent| %>
            <% child = target_datetime_children.find_by!(association_name(parent_model, :singular) => parent) %>
              <%= fields_for "#{association_name(children_model, :plural)}[#{child.id}]", child do |child_form| %>
                <% children_attributes.each do |options| %>
                  <td>
                    <% options[:disabled] = child.APPROVED? %>
                    <% case options[:builder] %>
                    <% when :text_field %>
                      <%= child_form.send(options.delete(:builder), options.delete(:attribute), options.merge(disabled: :disabled)) %>
                    <% when :select %>
                      <%= child_form.send(options.delete(:builder), options.delete(:attribute), options.delete(:possible_values), options.merge(disabled: :disabled)) %>
                    <% else %>
                      <% raise StandardError.new('Builder type for form not implemented') %>
                    <% end %>
                  </td>
                <% end %>
              <% end %>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>

<script>
  $(document).ready(function() {
    $('.date-changer-form').toggle();
    $('.date-changer-toggler').click(function(){
      $('.date-changer-form').toggle();
    });

    $('.date-changer-button').on('click', function(e){
      e.preventDefault();
      var target_date = $('.date-changer-date').val();
      var url = [location.protocol, '//', location.host, location.pathname].join('');
      window.location = (url + '?target_day=' + target_date);
    })

    $(".reset-toggleable").toggle();

    $( "#toggle-reset" ).on("click", {}, function(){
      $(".reset-toggleable").toggle();
    });
  });
</script>
